//! MAX7219 lib

#![deny(missing_docs)]
#![deny(warnings)]
#![feature(never_type)]
#![no_std]
#![feature(reverse_bits)]

extern crate embedded_hal as hal;

#[macro_use(block)]
extern crate nb;

#[derive(Clone, Copy, Debug, Eq, PartialEq)]
enum Max7219Regs {
    NoOp = 0x0,
    Digit0 = 0x1,
    Digit1 = 0x2,
    Digit2 = 0x3,
    Digit3 = 0x4,
    Digit4 = 0x5,
    Digit5 = 0x6,
    Digit6 = 0x7,
    Digit7 = 0x8,
    DecodeMode = 0x9,
    Intensity = 0xa,
    ScanLimit = 0xb,
    Shutdown = 0xc,
    DisplayTest = 0xf,
}


macro_rules! max7219_mac {
    ($size:expr) => {

        /// Pixels of all the LED matrices
        pub struct PixArray {
            pixels : [[u8;8]; $size]
        }

        impl PixArray {

            /// Creates a new and empty pixel buffer.
            pub fn new() -> PixArray {
                PixArray { pixels: [[0;8];$size] }
            }

            /// Returns a single block from a character.
            fn from(c : char) -> [u8;8] {
                let mut ret : [u8;8]  = match c {
                    '1' => [0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00111000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b01111110],

                    '2' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b00000110,
                            0b00001100,
                            0b00110000,
                            0b01100000,
                            0b01111110],

                    '3' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b00000110,
                            0b00011100,
                            0b00000110,
                            0b01100110,
                            0b00111100],

                    '4' => [0b00000000,
                            0b00001100,
                            0b00011100,
                            0b00101100,
                            0b01001100,
                            0b01111110,
                            0b00001100,
                            0b00001100],

                    '5' => [0b00000000,
                            0b01111110,
                            0b01100000,
                            0b01111100,
                            0b00000110,
                            0b00000110,
                            0b01100110,
                            0b00111100],
                    '6' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b00111100],
                    '7' => [0b00000000,
                            0b01111110,
                            0b01100110,
                            0b00001100,
                            0b00001100,
                            0b00011000,
                            0b00011000,
                            0b00011000],

                    '8' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b00111100],

                    '9' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b00111110,
                            0b00000110,
                            0b01100110,
                            0b00111100],

                    '0' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01101110,
                            0b01110110,
                            0b01100110,
                            0b01100110,
                            0b00111100],

                    'A' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b01111110,
                            0b01100110,
                            0b01100110,
                            0b01100110],
                    'B' => [0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01111100],
                    'C' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01100110,
                            0b00111100],
                    'D' => [0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01111100],
                    'E' => [0b00000000,
                            0b01111110,
                            0b01100000,
                            0b01100000,
                            0b01111100,
                            0b01100000,
                            0b01100000,
                            0b01111110],
                    'F' => [0b00000000,
                            0b01111110,
                            0b01100000,
                            0b01100000,
                            0b01111100,
                            0b01100000,
                            0b01100000,
                            0b01100000],
                    'G' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100000,
                            0b01100000,
                            0b01101110,
                            0b01100110,
                            0b00111100],
                    'H' => [0b00000000,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01111110,
                            0b01100110,
                            0b01100110,
                            0b01100110],
                    'I' => [0b00000000,
                            0b00111100,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00111100],
                    'J' => [0b00000000,
                            0b00011110,
                            0b00001100,
                            0b00001100,
                            0b00001100,
                            0b01101100,
                            0b01101100,
                            0b00111000],
                    'K' => [0b00000000,
                            0b01100110,
                            0b01101100,
                            0b01111000,
                            0b01110000,
                            0b01111000,
                            0b01101100,
                            0b01100110],
                    'L' => [0b00000000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01111110],
                    'M' => [0b00000000,
                            0b01100011,
                            0b01110111,
                            0b01111111,
                            0b01101011,
                            0b01100011,
                            0b01100011,
                            0b01100011],
                    'N' => [0b00000000,
                            0b01100011,
                            0b01110011,
                            0b01111011,
                            0b01101111,
                            0b01100111,
                            0b01100011,
                            0b01100011],
                    'O' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111100],
                    'P' => [0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01111100,
                            0b01100000,
                            0b01100000],
                    'Q' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01101110,
                            0b00111100,
                            0b00000110],
                    'R' => [0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01111100,
                            0b01111000,
                            0b01101100,
                            0b01100110],
                    'S' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100000,
                            0b00111100,
                            0b00000110,
                            0b01100110,
                            0b00111100],
                    'T' => [0b00000000,
                            0b01111110,
                            0b01011010,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000],
                    'U' => [0b00000000,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111110],
                    'V' => [0b00000000,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111100,
                            0b00011000],
                    'W' => [0b00000000,
                            0b01100011,
                            0b01100011,
                            0b01100011,
                            0b01101011,
                            0b01111111,
                            0b01110111,
                            0b01100011],
                    'X' => [0b00000000,
                            0b01100011,
                            0b01100011,
                            0b00110110,
                            0b00011100,
                            0b00110110,
                            0b01100011,
                            0b01100011],
                    'Y' => [0b00000000,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111100,
                            0b00011000,
                            0b00011000,
                            0b00011000],
                    'Z' => [0b00000000,
                            0b01111110,
                            0b00000110,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b01100000,
                            0b01111110],
                    'a' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b00000110,
                            0b00111110,
                            0b01100110,
                            0b00111110],
                    'b' => [0b00000000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01111100],
                    'c' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100000,
                            0b01100110,
                            0b00111100],
                    'd' => [0b00000000,
                            0b00000110,
                            0b00000110,
                            0b00000110,
                            0b00111110,
                            0b01100110,
                            0b01100110,
                            0b00111110],
                    'e' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01111110,
                            0b01100000,
                            0b00111100],
                    'f' => [0b00000000,
                            0b00011100,
                            0b00110110,
                            0b00110000,
                            0b00110000,
                            0b01111100,
                            0b00110000,
                            0b00110000],
                    'g' => [0b00000000,
                            0b00000000,
                            0b00111110,
                            0b01100110,
                            0b01100110,
                            0b00111110,
                            0b00000110,
                            0b00111100],
                    'h' => [0b00000000,
                            0b01100000,
                            0b01100000,
                            0b01100000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01100110],
                    'i' => [0b00000000,
                            0b00000000,
                            0b00011000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00111100],
                    'j' => [0b00000000,
                            0b00001100,
                            0b00000000,
                            0b00001100,
                            0b00001100,
                            0b01101100,
                            0b01101100,
                            0b00111000],
                    'k' => [0b00000000,
                            0b01100000,
                            0b01100000,
                            0b01100110,
                            0b01101100,
                            0b01111000,
                            0b01101100,
                            0b01100110],
                    'l' => [0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000],
                    'm' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100011,
                            0b01110111,
                            0b01111111,
                            0b01101011,
                            0b01101011],
                    'n' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01111100,
                            0b01111110,
                            0b01100110,
                            0b01100110,
                            0b01100110],
                    'o' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111100],
                    'p' => [0b00000000,
                            0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01111100,
                            0b01100000,
                            0b01100000],
                    'q' => [0b00000000,
                            0b00000000,
                            0b00111100,
                            0b01101100,
                            0b01101100,
                            0b00111100,
                            0b00001101,
                            0b00001111],
                    'r' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01111100,
                            0b01100110,
                            0b01100110,
                            0b01100000,
                            0b01100000],
                    's' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111110,
                            0b01000000,
                            0b00111100,
                            0b00000010,
                            0b01111100],
                    't' => [0b00000000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b01111110,
                            0b00011000,
                            0b00011000,
                            0b00011000],
                    'u' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b01100110,
                            0b00111110],
                    'v' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100110,
                            0b01100110,
                            0b00111100,
                            0b00011000],
                    'w' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100011,
                            0b01101011,
                            0b01101011,
                            0b01101011,
                            0b00111110],
                    'x' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100110,
                            0b00111100,
                            0b00011000,
                            0b00111100,
                            0b01100110],
                    'y' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100110,
                            0b01100110,
                            0b00111110,
                            0b00000110,
                            0b00111100],
                    'z' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b00111100],

                    '+' => [0b00000000,
                            0b00000000,
                            0b00001000,
                            0b00001000,
                            0b00111110,
                            0b00001000,
                            0b00001000,
                            0b00000000],
                    '-' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b00000000,
                            0b00000000,
                            0b00000000],
                    '*' => [0b00000000,
                            0b00000000,
                            0b00110110,
                            0b00011100,
                            0b01111111,
                            0b00011100,
                            0b00110110,
                            0b00000000],
                    '/' => [0b00000000,
                            0b00000000,
                            0b00000110,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b01100000,
                            0b00000000],
                    '%' => [0b00000000,
                            0b01100000,
                            0b01100110,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b01100110,
                            0b00000110],
                    '=' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111100,
                            0b00000000,
                            0b00111100,
                            0b00000000,
                            0b00000000],
                    '~' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00111010,
                            0b01101100,
                            0b00000000,
                            0b00000000,
                            0b00000000],
                    '^' => [0b00000000,
                            0b00001000,
                            0b00010100,
                            0b00100010,
                            0b01000001,
                            0b00000000,
                            0b00000000,
                            0b00000000],
                    '<' => [0b00000000,
                            0b00000110,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b00011000,
                            0b00001100,
                            0b00000110],
                    '>' => [0b00000000,
                            0b01100000,
                            0b00110000,
                            0b00011000,
                            0b00001100,
                            0b00011000,
                            0b00110000,
                            0b01100000],
                    '(' => [0b00000000,
                            0b00000110,
                            0b00001100,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00001100,
                            0b00000110],
                    ')' => [0b00000000,
                            0b01100000,
                            0b00110000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00110000,
                            0b01100000],
                    '[' => [0b00000000,
                            0b00011110,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011110],
                    ']' => [0b00000000,
                            0b01111000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b00011000,
                            0b01111000],
                    '{' => [0b00000000,
                            0b00001110,
                            0b00011000,
                            0b00011000,
                            0b00110000,
                            0b00011000,
                            0b00011000,
                            0b00001110],
                    '}' => [0b00000000,
                            0b01110000,
                            0b00011000,
                            0b00011000,
                            0b00001100,
                            0b00011000,
                            0b00011000,
                            0b01110000],
                    '.' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b01100000,
                            0b01100000],
                    ':' => [0b00000000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00000000],
                    ';' => [0b00000000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00000000,
                            0b00011000,
                            0b00011000,
                            0b00110000],
                    ',' => [0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00000000,
                            0b00110000,
                            0b00110000,
                            0b00110000,
                            0b01100000],
                    '!' => [0b00000000,
                            0b00011000,
                            0b00111100,
                            0b00111100,
                            0b00011000,
                            0b00011000,
                            0b00000000,
                            0b00011000],
                    '?' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b00000110,
                            0b00011100,
                            0b00011000,
                            0b00000000,
                            0b00011000],
                    '@' => [0b00000000,
                            0b00111000,
                            0b01000100,
                            0b01011100,
                            0b01011000,
                            0b01000010,
                            0b00111100,
                            0b00000000],
                    '&' => [0b00000000,
                            0b00111100,
                            0b01100110,
                            0b00111100,
                            0b00101000,
                            0b01100101,
                            0b01100110,
                            0b00111111],
                    '$' => [0b00000000,
                            0b00001000,
                            0b00011110,
                            0b00100000,
                            0b00011100,
                            0b00000010,
                            0b00111100,
                            0b00001000],
                    '#' => [0b00000000,
                            0b00110110,
                            0b00110110,
                            0b01111111,
                            0b00110110,
                            0b01111111,
                            0b00110110,
                            0b00110110],
                    '↑' => [0b00000000,
                            0b00001000,
                            0b00011100,
                            0b00111110,
                            0b01111111,
                            0b00011100,
                            0b00011100,
                            0b00011100],
                    '↓' => [0b00000000,
                            0b00011100,
                            0b00011100,
                            0b00011100,
                            0b01111111,
                            0b00111110,
                            0b00011100,
                            0b00001000],
                    '→' => [0b00000000,
                            0b00001000,
                            0b00001100,
                            0b01111110,
                            0b01111111,
                            0b01111110,
                            0b00001100,
                            0b00001000],
                    '←' => [0b00000000,
                            0b00001000,
                            0b00011000,
                            0b00111111,
                            0b01111111,
                            0b00111111,
                            0b00011000,
                            0b00001000],
                    '▲' => [0b00000000,
                            0b00001000,
                            0b00011100,
                            0b00011100,
                            0b00111110,
                            0b00111110,
                            0b01111111,
                            0b01111111],
                    '▼' => [0b00000000,
                            0b01111111,
                            0b01111111,
                            0b00111110,
                            0b00111110,
                            0b00011100,
                            0b00011100,
                            0b00001000],
                    '▶' => [0b00000000,
                            0b01100000,
                            0b01111000,
                            0b01111110,
                            0b01111111,
                            0b01111110,
                            0b01111000,
                            0b01100000],
                    '◀' => [0b00000000,
                            0b00000011,
                            0b00001111,
                            0b00111111,
                            0b01111111,
                            0b00111111,
                            0b00001111,
                            0b00000011],
                    // '1' => [0b00000000,
                    //                            0b00111110,
                    //                            0b01000001,
                    //                            0b01010101,
                    //                            0b01000001,
                    //                            0b01010101,
                    //                            0b01001001,
                    //                            0b00111110],
                    // '1' => [0b00000000,
                    //                            0b00111110,
                    //                            0b01111111,
                    //                            0b01101011,
                    //                            0b01111111,
                    //                            0b01101011,
                    //                            0b01110111,
                    //                            0b00111110],
                    // '1' => [0b00000000,
                    //                            0b00100010,
                    //                            0b01110111,
                    //                            0b01111111,
                    //                            0b01111111,
                    //                            0b00111110,
                    //                            0b00011100,
                    //                            0b00001000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00111110,
                    //                            0b01111111,
                    //                            0b00111110,
                    //                            0b00011100,
                    //                            0b00001000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00101010,
                    //                            0b01111111,
                    //                            0b00101010,
                    //                            0b00001000,
                    //                            0b00011100],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00111110,
                    //                            0b01111111,
                    //                            0b00111110,
                    //                            0b00001000,
                    //                            0b00011100],
                    // '1' => [0b00000000,
                    //                            0b00000000,
                    //                            0b00011100,
                    //                            0b00111110,
                    //                            0b00111110,
                    //                            0b00111110,
                    //                            0b00011100,
                    //                            0b00000000],
                    // '1' => [0b11111111,
                    //                            0b11111111,
                    //                            0b11100011,
                    //                            0b11000001,
                    //                            0b11000001,
                    //                            0b11000001,
                    //                            0b11100011,
                    //                            0b11111111],
                    // '1' => [0b00000000,
                    //                            0b00000000,
                    //                            0b00011100,
                    //                            0b00100010,
                    //                            0b00100010,
                    //                            0b00100010,
                    //                            0b00011100,
                    //                            0b00000000],
                    // '1' => [0b11111111,
                    //                            0b11111111,
                    //                            0b11100011,
                    //                            0b11011101,
                    //                            0b11011101,
                    //                            0b11011101,
                    //                            0b11100011,
                    //                            0b11111111],
                    // '1' => [0b00000000,
                    //                            0b00001111,
                    //                            0b00000011,
                    //                            0b00000101,
                    //                            0b00111001,
                    //                            0b01001000,
                    //                            0b01001000,
                    //                            0b00110000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00111110,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00100010,
                    //                            0b00100010,
                    //                            0b00011100],
                    // '1' => [0b00000000,
                    //                            0b00011000,
                    //                            0b00010100,
                    //                            0b00010000,
                    //                            0b00010000,
                    //                            0b00110000,
                    //                            0b01110000,
                    //                            0b01100000],
                    // '1' => [0b00000000,
                    //                            0b00001111,
                    //                            0b00011001,
                    //                            0b00010001,
                    //                            0b00010011,
                    //                            0b00110111,
                    //                            0b01110110,
                    //                            0b01100000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00101010,
                    //                            0b00011100,
                    //                            0b01110111,
                    //                            0b00011100,
                    //                            0b00101010,
                    //                            0b00001000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00101010,
                    //                            0b00001000,
                    //                            0b00101010,
                    //                            0b00011100,
                    //                            0b00001000],
                    // '1' => [0b00000000,
                    //                            0b01100110,
                    //                            0b01100110,
                    //                            0b01100110,
                    //                            0b01100110,
                    //                            0b00000000,
                    //                            0b01100110,
                    //                            0b01100110],
                    // '1' => [0b00000000,
                    //                            0b00000000,
                    //                            0b00010100,
                    //                            0b00100010,
                    //                            0b01111111,
                    //                            0b00100010,
                    //                            0b00010100,
                    //                            0b00000000],
                    // '1' => [0b00000000,
                    //                            0b00110110,
                    //                            0b00110110,
                    //                            0b00010100,
                    //                            0b00000000,
                    //                            0b00000000,
                    //                            0b00000000,
                    //                            0b00000000],
                    // '1' => [0b00000000,
                    //                            0b00000000,
                    //                            0b01100000,
                    //                            0b00110000,
                    //                            0b00011000,
                    //                            0b00001100,
                    //                            0b00000110,
                    //                            0b00000000],
                    // '1' => [0b00000000,
                    //                            0b00001100,
                    //                            0b00001100,
                    //                            0b00000110,
                    //                            0b00000000,
                    //                            0b00000000,
                    //                            0b00000000,
                    //                            0b00000000],
                    // '1' => [0b00000000,
                    //                            0b00011000,
                    //                            0b00011000,
                    //                            0b00011000,
                    //                            0b00110000,
                    //                            0b00000000,
                    //                            0b00000000,
                    //                            0b00000000],
                    // '1' => [0b00000000,
                    //                            0b00001000,
                    //                            0b00011100,
                    //                            0b00110110,
                    //                            0b01100011,
                    //                            0b01000001,
                    //                            0b01000001,
                    //                            0b01111111],
                    _ => [0;8]
                };
                for x in &mut ret {
                    *x = (*x).reverse_bits();
                }
                ret
            }

            /// Modify the pixel buffer to match `s` string content.
            pub fn fromstr(&mut self, s: &str) {
                for i in 0..$size {
                    self.pixels[i] = PixArray::from(s.as_bytes()[i] as char);
                }
            }

            /// Modify the pixel buffer to match `s` byte array content.
            pub fn fromarr(&mut self, s: &[u8]) {
                for i in 0..$size {
                    self.pixels[i] = PixArray::from(s[i] as char);
                }
            }

            /// Sets the value to `v` for the pixel at position `line`, `col`.
            pub fn set_pixel(&mut self, line : usize, col : usize , v : bool) {
                let block = col / 8;
                if v {
                    self.pixels[block][line] |= 1<<col;
                } else {
                    self.pixels[block][line] &= !(1<<col );
                }
            }

            /// Gets the value of the pixel at position `line`, `col`.
            pub fn get_pixel(&self, line : usize, col : usize) -> u8 {
                self.pixels[col / 8][line] & (1<<col) as u8
            }

            /// Gets the values of pixels in LED block `block` and line `l`.
            pub fn get_pixel_line(&self, block: usize, l : usize) -> u8 {
                self.pixels[block][l]
            }

            /// Shifts left the pixel buffer. If `rotate` is true,
            /// performs a rotation (ie. pixels going out on the left
            /// are used for the new pixels on the right).
            pub fn lshift(&mut self, rotate : bool) {
                for line in 0..8 {
                    let mut inp = if rotate { self.pixels[0][line] & 1 } else { 0 };
                    let mut outp;

                    for block in (0..$size).rev() {
                        let mut v = self.pixels[block][line];
                        outp = v & 1;
                        v = (inp<<7) | (v>>1);
                        self.pixels[block][line] = v;
                        inp = outp;
                    }
                }
            }

            /// Shifts right the pixel buffer. If `rotate` is true,
            /// performs a rotation (ie. pixels going out on the right
            /// are used for the new pixels on the left).
            pub fn rshift(&mut self, rotate : bool) {
                for line in 0..8 {
                    let mut inp = if rotate { (self.pixels[$size-1][line] & (1<<7))>>7 } else { 0 };
                    let mut outp;

                    for block in 0..$size {
                        let mut v = self.pixels[block][line];
                        outp = (v & (1<<7))>>7;
                        v = inp | (v<<1);
                        self.pixels[block][line] = v;
                        inp = outp;
                    }
                }
            }

            // Set line
            // pub fn set_pixel_line(&mut self, l : usize, v: u8) {
            //     self.pixels[l] = v;
            // }
        }

        impl From<u8> for Max7219Regs {
            fn from(reg_index: u8) -> Self {
                match reg_index {
                    0 => Max7219Regs::Digit0,
                    1 => Max7219Regs::Digit1,
                    2 => Max7219Regs::Digit2,
                    3 => Max7219Regs::Digit3,
                    4 => Max7219Regs::Digit4,
                    5 => Max7219Regs::Digit5,
                    6 => Max7219Regs::Digit6,
                    7 => Max7219Regs::Digit7,
                    _ => Max7219Regs::NoOp,
                }
            }
        }

        /// Device descriptor
        #[derive(Clone, Copy, PartialEq)]
        pub struct Max7219<S,P> {
            spi : S,
            cs : P,
        }

        impl<S,P> Max7219<S,P>
            where S: hal::spi::FullDuplex<u8>,
                  P: hal::digital::OutputPin {

            /// Creates a new device descriptor
            pub fn new(spi: S, cs: P) -> Max7219<S,P> {
                Max7219 {
                    spi : spi,
                    cs : cs,
                }
            }

            fn set_reg(&mut self, reg: Max7219Regs, val: u8) {
                // FIXME: looks ugly, need to handle this correctly.

                // using unwrap() does not work as underlying Error do not
                // implement the Debug trait...
                match block!(self.spi.send(reg as u8)) {
                    _ => {}
                }
                match block!(self.spi.send(val)) {
                    _ => {}
                }

            }

            /// Writes a line
            pub fn write_lines(&mut self, line_index: u8, vals: &[u8]) {
                self.cs.set_low();
                for i in 0..$size {
                    self.set_reg(Max7219Regs::from(line_index), vals[i as usize]);
                }
                self.cs.set_high();

            }

            /// Writes a pixel buffer
            pub fn write_pixbuf(&mut self, pixbuf: &PixArray) {
                for l in 0..8 {
                    let line = Max7219Regs::from(7-l);
                    self.cs.set_low();
                    for i in (0..$size).rev() {
                        self.set_reg(line, pixbuf.get_pixel_line(i ,l as usize));
                    }
                    self.cs.set_high();
                }
            }

            /// Initializes the device
            pub fn init(&mut self) {
                self.cs.set_low();
                for _i in 0..$size {
                    // Shutdown
                    self.set_reg(Max7219Regs::Shutdown, 0);
                }
                self.cs.set_high();

                self.cs.set_low();
                for _i in 0..$size {
                    // Midpower intensity
                    self.set_reg(Max7219Regs::Intensity, 0x4);
                }
                self.cs.set_high();

                self.cs.set_low();
                for _i in 0..$size {
                    // Disable test mode
                    self.set_reg(Max7219Regs::DisplayTest, 0x0);
                }
                self.cs.set_high();

                self.cs.set_low();
                for _i in 0..$size {
                    // Disable char decoding
                    self.set_reg(Max7219Regs::DecodeMode, 0);
                }
                self.cs.set_high();

                self.cs.set_low();
                for _i in 0..$size {
                    // Display all digit
                    self.set_reg(Max7219Regs::ScanLimit, 0x07);
                }
                self.cs.set_high();

                self.cs.set_low();
                for _i in 0..$size {
                    // Enable
                    self.set_reg(Max7219Regs::Shutdown, 1);
                }
                self.cs.set_high();
            }
        }
    }
}

max7219_mac! (4);
